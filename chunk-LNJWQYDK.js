import{a as f}from"./chunk-ZYWFXMK7.js";import{a as A,b as T}from"./chunk-4VDU63PD.js";import{O as h,T as m,j as d,m as l,n as u,q as c,y as s}from"./chunk-VD7T3VHC.js";var g=class p{http=m(T);apiUrl=`${f.apiUrl}/attendance`;getAuthHeaders(){let e=localStorage.getItem("token");return new A({"Content-Type":"application/json",Authorization:e?`Bearer ${e}`:""})}attendanceSubject=new d([]);attendance$=this.attendanceSubject.asObservable();getAllAttendance(){return this.http.get(this.apiUrl).pipe(c(e=>this.convertDTOsToAttendance(e)),s(this.handleError))}getAllAttendanceDTO(){return this.http.get(this.apiUrl).pipe(s(this.handleError))}recordAttendance(e){return this.http.post(`${this.apiUrl}/record`,e).pipe(s(this.handleError))}getAttendanceById(e){return this.http.get(`${this.apiUrl}/${e}`).pipe(s(this.handleError))}getAttendancesByDate(e){return this.http.get(`${this.apiUrl}/date/${e}`).pipe(c(t=>this.convertDTOsToAttendance(t)),s(this.handleError))}getStaffAttendances(e){return this.http.get(`${this.apiUrl}/staff/${e}`).pipe(c(t=>this.convertDTOsToAttendance(t)),s(this.handleError))}getAttendancesByDepartment(e){return this.http.get(`${this.apiUrl}/department/${e}`).pipe(c(t=>this.convertDTOsToAttendance(t)),s(this.handleError))}getStaffAttendanceByDate(e,t){return this.http.get(`${this.apiUrl}/staff/${e}/date/${t}`).pipe(s(a=>a.status===404?l(null):this.handleError(a)))}convertDTOsToAttendance(e){return e.map(t=>this.convertDTOToAttendance(t))}convertDTOToAttendance(e){let t=e.arrivalTime?this.extractTime(e.arrivalTime):void 0,a=e.departureTime?this.extractTime(e.departureTime):void 0,n=this.calculateHoursWorked(e.arrivalTime,e.departureTime),r=this.mapBackendStatusToFrontend(e.status,e.arrivalTime,e.departureTime);return{id:e.attendanceId.toString(),staffId:e.staffId.toString(),staffName:`${e.staffName} ${e.staffSurname}`,department:e.departmentName||"Unassigned",date:new Date(e.attendanceDate),checkIn:t,checkOut:a,hoursWorked:n,status:r}}extractTime(e){try{let t=new Date(e),a=t.getHours().toString().padStart(2,"0"),n=t.getMinutes().toString().padStart(2,"0");return`${a}:${n}`}catch{return e}}calculateHoursWorked(e,t){if(!e||!t)return 0;try{let a=new Date(e),i=(new Date(t).getTime()-a.getTime())/(1e3*60*60);return Math.round(i*10)/10}catch{return 0}}mapBackendStatusToFrontend(e,t,a){if(e==="COMPLETE"||e==="DEPARTURE_RECORDED"){if(t){let n=new Date(t),r=n.getHours(),i=n.getMinutes();if(r>9||r===9&&i>0)return"late"}return"present"}else{if(e==="ARRIVAL_RECORDED")return"present";if(e==="INCOMPLETE")return"absent"}return"present"}handleError(e){let t="An error occurred";return e.error instanceof ErrorEvent?t=`Error: ${e.error.message}`:t=e.error?.error||e.message||`Error Code: ${e.status}`,console.error("AttendanceService Error:",t),u(()=>new Error(t))}getTodayAttendance(){let e=new Date().toISOString().split("T")[0];return this.getAttendancesByDate(e)}getStats(){let e=new Date().toISOString().split("T")[0];return this.getAttendancesByDate(e).pipe(c(t=>{let a=t.filter(r=>r.checkIn).length,n=t.filter(r=>{if(!r.checkIn)return!1;let[i,o]=r.checkIn.split(":").map(Number);return i>9||i===9&&o>0}).length;return{totalStaff:0,presentToday:a,absent:0,lateArrivals:n,onLeave:0,attendanceRate:0,lateArrivalRate:a>0?n/a*100:0}}),s(this.handleError))}getRecentCheckIns(){let e=new Date().toISOString().split("T")[0];return this.getAttendancesByDate(e).pipe(c(t=>t.filter(n=>n.checkIn).map(n=>{let[r,i]=n.checkIn.split(":").map(Number),o=new Date;return o.setHours(r,i,0,0),{attendance:n,time:o}}).sort((n,r)=>r.time.getTime()-n.time.getTime()).slice(0,5).map(n=>{let[r,i]=n.attendance.checkIn.split(":").map(Number),o=r>9||r===9&&i>0;return{name:n.attendance.staffName,time:n.attendance.checkIn,status:o?"Late":"On time"}})),s(this.handleError))}static \u0275fac=function(t){return new(t||p)};static \u0275prov=h({token:p,factory:p.\u0275fac,providedIn:"root"})};export{g as a};
